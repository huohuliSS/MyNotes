> author : huohuliSS

[TOC]

# 计算机网络

## 一、概述

### 互联网概述

> 定义：计算机网络就是互联的、自治（无主从关系）的计算机集合

什么是网络协议？

> 是为了进行网络中的数据交换而建立的规则、标准或约定。

协议规定了通信实体之间所交换的消息的格式、意义、顺序以及针对收到信息或发生的事件所采取的的“动作”

协议的三要素？

> 1.语法(Syntax)     数据与控制信息的结构与格式
>
> 2.语义(Semantics)   即需要发出何种控制信息，完成何种动作以及做出何种响应
>
> 3.时序/同步(Timing)   即事件的详细说明

### 体系结构

**OSI参考模型**

> **应用层**（数据）  确定进程之间通信的性质以满足用户需要以及提供网络与用户应用
>
> **表示层**（数据）  在传输之前是否进行加密或压缩处理
>
> **会话层**（数据）  提供包括访问验证和会话管理在内的建立和维护应用之间通信的机制，如服务器验证用户登录便是由会话完成的。查木马
>
> **传输层**（段）  实现网络之间不同主机上用户进程之间的数据通信，可靠和不可靠传输，传输层的错误检测、流量控制等
>
> **网络层**（包）  负责选择最佳路径，规划IP地址
>
> **数据链路层**（帧）  将上层数据封装成帧，用MAC地址访问媒介  透明传输  差错校验
>
> **物理层**（比特流）  接口标准  电器标准  如何在物理链路上传输更快的速度

OSI参考模型与对网络排错指导

> 物理层故障    查看连接状态 发送和接受的数据包
>
> 数据链路层故障   MAC冲突  ADSL(wifi)欠费、网速没办法保持协商一致  计算机连接到错误的VLAN
>
> 网络层故障   配置错误IP地址   子网掩码  配置错误的网关  路由器没有配置到达目标网络的路由
>
> 应用层故障   应用程序配置错误

TCP/IP分层（4层）

> 网络接口层    网际层    运输层    应用层

五层协议的体系结构

> 应用层     传输层      网络层     数据链路层     物理层

### 计算机网络性能

1.速率   ：连接在计算机网络上的主机在数字信道上传输数据位的速率，也称data rate 或 bit rate

2.带宽   ： 数据通信领域中，数字信道所能传送的最高数据率

3.吞吐量   ：  即在单位时间内通过某个网络的数据量；

4.时延   ： 发送延迟、传播延迟、处理延迟、排队延迟

5.时延宽积    ： 传播时延 * 带宽

6.往返时间    ：  从发送方发送数据开始，到发送方收到接收方确认

7.利用率    ：  

## 二、物理层

原文链接：https://blog.csdn.net/zx48822821/article/details/81431678

介绍：物理层是计算机网络的第一层，它为设备之间的数据通信提供传输媒介及互连设备，为数据传送提供更可靠的环境。

### 数据通信的基础知识

**数据通信系统的模型**

可分为三大部分：源系统、传输系统和目的系统

![](https://img-blog.csdn.net/20180805152840401?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p4NDg4MjI4MjE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

通信的目的是传送`消息(message)`。如话音、文字、图像、视频等都是消息。`数据(data)`是运送消息的实体。根据RFC 4949给出的定义，数据是使用特定方式表示的信息，通常是有意义的符号序列。这种信息的表示可用计算机或其他机器(或人)处理或产生。`信号(signal)`则是数据的电气或电磁的表现。

根据信号中代表消息的参数的取值方式不同，信号可分为以下两大类：

- `模拟信号`，或连续信号，—代表消息的参数的取值是连续的。例如在图中，用户家中的调制解调器到电话端局之间的用户线上传送的就是模拟信号。
- `数字信号`，或离散信号，—代表消息的参数的取值是离散的。例如在图中，用户家中的计算机到调制解调器之间，或在电话网中继线上传送的就是数字信号。在使用时间域(或简称为时域)的波形表示数字信号时，代表不同离散数值的基本波形就称为`码元`。在使用二进制编码时，只有两种不同的码元，一种代表0状态而另一种代表1状态。

### 有关信道的几个基本概念

在许多情况下，我们要使用`信道(channel)`这一名词。信道和电路并不等同。信道一般都是用来表示向某一个方向传送信息的媒体。因此，一条通信电路往往包含一条发送信道和一条接收信道。从通信的双方信息交互的方式来看，可以有以下三种基本方式：

- `单向通信`又称为`单工通信`，即只能有一个方向的通信而没有反方向的交互。无线电广播或有线电广播以及电视广播就属于这种类型。
- `双向交替通信`又称为`半双工通信`，即通信的双方都可以发送信息，但不能双方同时发送(当然也就不能同时接收)。这种通信方式是一方发送另一方接收，过一段时间后可以再反过来。
- `双向同时通信`又称为`全双工通信`，即通信的双方可以同时发送和接收信息。单向通信只需要一条信道，而双向交替通信或双向同时通信则都需要两条信道(每个方向各一条)。显然，双向同时通信的传输效率最高。

来自信源的信号常称为`基带信号`(即基本频带信号)。像计算机输出的代表各种文字或图像文件的数据信号都属于基带信号。许多信道并不能传输基带信号中的低频分量或直流分量。为了解决这一问题，就必须对基带信号进行`调制(modulation)`。调制可分为两大类：

- 这类调制称为`基带调制`。仅仅对基带信号的波形进行变换，使它能够与信道特性相适应。变换后的信号仍然是基带信号。由于这种基带调制是把数字信号转换为另一种形式的数字信号，因此大家更愿意把这种过程称为`编码(coding)`。
- 这类调制称为`带通调制`。使用载波(carrier)进行调制，把基带信号的频率范围搬移到较高的频段，并转换为模拟信号，这样就能够更好地在模拟信道中传输。经过载波调制后的信号称为`带通信号`(即仅在一段频率范围内能够通过信道)。

![](https://img-blog.csdn.net/20180805152915515?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p4NDg4MjI4MjE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

常用编码方式，如上图，`不归零制`正电平代表1，负电平代表0；`归零制`正脉冲代表1，负脉冲代表0；`曼彻斯特编码`位周期中心的向上跳变代表0，位周期中心的向下跳变代表但也可反过来定义；`差分曼彻斯特编码`在每一位的中心处始终都有跳变。位开始边界有跳变代表0，而位开始边界没有跳变代表。

![](https://img-blog.csdn.net/20180805153008230?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p4NDg4MjI4MjE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

常用带通调制，如上图。`调幅(AM)`即载波的振幅随基带数字信号而变化。例如，0或1分别对应于无载波或有载波输出；`调频((FM)`即载波的频率随基带数字信号而变化。例如，0或1分别对应于频率 f1 或 f2 ;`调相(PM)`即载波的初始相位随基带数字信号而变化。例如，0或1分别对应于相位0度或180度。

### 信道的极限容量

任何实际的信道都不是理想的，都不可能以任意高的速率进行传送。数字通信的优点就是：虽然信号在信道上传输时会不可避免地产生失真，但在接收端只要我们从失真的波形中能够识别出原来的信号，那么这种失真对通信质量就没有影响。如图：

![](https://img-blog.csdn.net/20180805153044667?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p4NDg4MjI4MjE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

从概念上讲，限制码元在信道上的传输速率的因素有以下两个：

1、信道能够通过的频率范围

> 由于系统传输总特性不理想，导致前后码元的波形畸变、展宽，并使前面波形出现很长的拖尾，蔓延到当前码元的抽样时刻上，从而对当前码元的判决造成干扰，这就是`码间串扰`，如上图(b)。为了避免码间串扰，`奈奎斯特(Nyquist)`推导出了著名的`奈氏准则`。他给出了在假定的理想条件下，为了避免码间串扰，码元的传输速率的上限值。所以，**在任何信道中，码元传输的速率是有上限的，传输速率超过此上限，就会出现严重的码间串扰的问题，使接收端对码元的判决(即识别)成为不可能。**

2、信噪比

>噪声存在于所有的电子设备和通信信道中。信噪比就是信号的平均功率和噪声的平均功率之比，常记为S/N，并用分贝(dB)作为度量单位。在1948年，信息论的创始人`香农`((Shannon)推导出了著名的`香农公式`。香农公式指出，信道的极限信息传输速率C是
>                                                             C=Wlog2(1+S/N)(bit/s)
>式中，W为信道的带宽(以Hz为单位)，S为信道内所传信号的平均功率，N为信道达部的高斯噪声功率。香农公式表明，信道的带宽或信道中的信噪比越大，信息的极限传输速率就越高。香农公式指出了信息传输速率的上限。香农公式的意义在于：只要信息传输速率低于信道的极限信息传输速率，就一定存在某种办法来实现无差错的传输。

### 信号复用技术

**多路复用技术是指在一条通信线路上传输多路信号，以提高通信线路利用率的技术。**

共分为4种：

> - **频分复用**
> - **时分复用**
> - 波分复用
> - 码分复用

#### 频分复用FDM、时分复用TDM

![](https://img-blog.csdn.net/20180805153109345?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p4NDg4MjI4MjE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

频分复用最简单，其特点如上图(a)所示。用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。可见**频分复用的所有用户在同样的时间占用不同的带宽资源**(请注意，这里的“带宽”是频率带宽而不是数据的发送速率)。

而时分复用则是将时间划分为一段段等长的时分复用帧( TDM 帧)。每一个时分复用的用户在每一个TDM帧中占用固定序号的时隙。

为简单起见，在上图(b)中只画出了4个用户A,B, C和D。每一个用户所占用的时隙周期性地出现(其周期就是TDM帧的长度)。因此TDM信号也称为`等时((isochronous)信号`。可以看出，**时分复用的所有用户是在不同的时间占用同样的频带宽度**。这两种复用方法的优点是技术比较成熟，但缺点是不够灵活。时分复用则更有利于数字信号的传输。

#### 统计时分复用STDM (Statistic TDM)

统计时分复用STDM (Statistic TDM)是一种改进的时分复用，它能明显地提高信道的利用率。集中器(concentrator)常使用这种统计时分复用。

![](https://img-blog.csdn.net/20180805153120804?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p4NDg4MjI4MjE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

上图是统计时分复用的原理图。一个使用统计时分复用的集中器连接4个低速用户，然后将它们的数据集中起来通过高速线路发送到一个远程计算机。

统计时分复用使用STDM帧来传送复用的数据。但每一个STDM帧中的时隙数小于连接在集中器上的用户数。各用户有了数据就随时发往集中器的输入缓存，然后集中器按顺序依次扫描输入缓存，把缓存中的输入数据放入STDM帧中。对没有数据的缓存就跳过去。当一个帧的数据放满了，就发送出去。

**波分复用WDM (Wavelength Division Multiplexing)**
波分复用WDM (Wavelength Division Multiplexing)就是光的频分复用。光纤技术的应用使得数据的传输速率空前提高。现在人们借用传统的载波电话的频分复用的概念，就能做到使用一根光纤来同时传输多个频率很接近的光载波信号。这样就使光纤的传输能力可成倍地提高。由于光载波的频率很高，因此习惯上用波长而不用频率来表示所使用的光载波。这样就得出了波分复用这一名词。

![](https://img-blog.csdn.net/20180805153129589?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p4NDg4MjI4MjE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

#### 码分复用CDM (Code Division Multiplexing)

码分复用CDM (Code Division Multiplexing)是另一种共享信道的方法，这里只简单介绍一下。实际上，人们更常用的名词是码分多址CDMA (Code Division Multiple Access)。每一个用户可以在同样的时间使用同样的频带进行通信。

由于各用户使用经过特殊挑选的不同码型，因此各用户之间不会造成干扰。码分复用最初用于军事通信，因为这种系统发送的信号有很强的抗干扰能力，其频谱类似于白噪声，不易被敌人发现。

随着技术的进步，CDMA设备的价格和体积都大幅度下降，因而现在已广泛使用在民用的移动通信中，特别是在无线局域网中。采用CDMA可提高通信的话音质量和数据传输的可靠性，减少干扰对通信的影响，增大通信系统的容量(是使用GSM的4-5倍)，降低手机的平均发射功率，等等。

## 三、数据链路层

**数据链路层功能：将上层的数据封装成帧，用MAC地址访问媒介**

### 数据链路层基本概念和基本问题

该层的作用包括: **物理地址寻址(添加MAC)**、**数据的成帧**、流量控制、**数据的检错**、重发等

数据链路层设备为 **交换机**

数据链路层的协议包括：

- PPP协议
- HDLC(高级数据链路控制)协议
- CSMA协议
- Ethernet(以太网)
- 帧中继等

链路层使用的信道主要有以下两种类型

> - 点对点信道 （一对一）
> - 广播信道（一对多）

### 三个基本问题

> - **封装成帧**   帧是数据链路层的传送单位。在一段数据的前后分别添加首部和尾部，一个帧的首部和尾部的重要作用是**帧定界**（确认帧的界限）
>
> 每一种链路层协议都规定了所能传送的帧的**数据部分长度上限——最大传输单元(MTU)**
>
> ![](https://img-blog.csdn.net/20170409121459955?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYXpzeDAy/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)
>
> - **透明传输**
>
> 用`字节填充法`或`字符填充法`解决透明传输问题
>
> - **差错检测**
>
> **循环冗余检验**(**CRC**)是一种常用的检错方法，而帧检测序列(**FCS**)是添加在数据后面的冗余码
>
> ![](https://img-blog.csdn.net/20180707115226836?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3podW95YV8=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

### 点对点通信的数据链路层使用 

#### (**PPP协议** -> Point-to-Point Propocol)

三个组成部分

> - 数据链路层协议可以异步串行或同步串行介质
>
> - 它使用**LCP**（链路控制协议）建立并维护数据链路连接
>
>   ​        链路控制协议LCP：用来建立，配置，测试，管理数据链路
>
>   
>
> - 网络控制协议(**NCP**)允许在点到点连接上使用多种网络层协议

![](https://images2017.cnblogs.com/blog/1044665/201712/1044665-20171224140409396-1066760722.png)

### 广播信道的数据链路层使用

#### CSMA/CD协议

> **多点接入** ： 表示许多极端及以多点接入连接到一根总线上
>
> **载波监听** ： 检测信道，就是用电子技术检测总线上有没有其他计算机也在发送的数字信号
>
> **碰撞检测** ：边发送边监听，既适配器边发送数据边检测信道上的信号电压的变化情况，以便判断自己在发送数据时其他站是否也在发送数据。

使用CSMA/CD协议的以太网不能进行全双工通信，而只能进行**双向交替通信**（半双工通信）。

补充：

> 以太网规定一个最短帧长64字节，既512bit.如果要发送的数据非常少，那么必须加入一些填充字节，使得帧长不小于64字节。
>
> 从总线网到**星形网**，以太网交换机已经不使用共享总线，因此就没有了碰撞问题，也就不使用CSMA/CD协议，也就没有了争用期，而是以全双工的方式工作。之所以还叫以太网是因为它的帧结构没有改变，仍然采用的是以太网的帧结构。

### 什么是以太网（以太局域网）

- DIX Ethernet V2，是世界上第一个局域网产品的规约。
- “以太网”应当是符合DIX Ethernet V2标准的局域网

**以太网和局域网的区别**

分类区别：以太网归为总线型局域网，而局域网的拓扑结构包括星形、树形、环形和总线型，局域网是四者的统称。

使用协议区别：以太网通常使用CSMA/CD协议，而局域网的使用协议多样，包括TCP/IP协议，IPX/SPX协议、NetBEUI协议等。

### MAC层的硬件地址(MAC地址)

在局域网中，硬件地址又称物理地址，或MAC地址

MAC（硬件）地址长48位（6字节），采用十六进制格式，下图说明了48位的MAC地址及其组成部分。

![](http://helian.info/wp-content/uploads/2016/01/wpid-0510366a02871a97c6252b9240b2ea87_06cb283e-ec0b-456c-87e0-9be4bbf25139.jpg)

OUI是英文Organizationally Unique Identifier的缩写，中文译为“组织唯一标识符”。这是由电器和电子工程师协会（IEEE）分配给单位组织的，它包含了24位（3字节）。各个单位组织依次被分配一个全局管理地址(24位，或3个字节)，对于厂家生产的每一块网卡来说，这个地址是唯一的。        在任何一块网卡（NIC）中烧录的6字节MAC地址中，以太网采用介质访问控制(Media Access Control，MAC)地址进行寻址。MAC地址也叫做硬件地址，它采用48位(6字节)的十六进制格式。48位的MAC地址包括两部分：24位组织唯一标志符(OUI)和剩下的24位由厂家分配的代码。前24位体现了OUI，其表明了NIC的制造组织。通常情况下，该标识符是唯一的。

### MAC帧格式

以太帧起始部分由前同步码和帧开始定界符组成，后面紧跟着一个以太网报头，以 MAC 地址说明目的地址和源地址。以太帧的中部是该帧负载的包含其他协议报头的数据包，如 IP 协议。

以太帧由一个 32 位冗余校验码结尾，用于检验数据传输是否出现损坏。以太帧结构如图所示。  

![](http://c.biancheng.net/uploads/allimg/191106/6-191106130541362.gif)

|      字段      |                             含义                             |
| :------------: | :----------------------------------------------------------: |
|    前同步码    | 用来使接收端的适配器在接收 MAC 帧时能够迅速调整时钟频率，使它和发送端的频率相同。前同步码为 7 个字节，1 和 0 交替。 |
|  帧开始定界符  | 帧的起始符，为 1 个字节。前 6 位 1 和 0 交替，最后的两个连续的 1 表示告诉接收端适配器：“帧信息要来了，准备接收”。 |
|    目的地址    | 接收帧的网络适配器的物理地址（MAC 地址），为 6 个字节（48 比特）。作用是当网卡接收到一个数据帧时，首先会检查该帧的目的地址，是否与当前适配器的物理地址相同，如果相同，就会进一步处理；如果不同，则直接丢弃。 |
|     源地址     | 发送帧的网络适配器的物理地址（MAC 地址），为 6 个字节（48 比特）。 |
|      类型      | 上层协议的类型。由于上层协议众多，所以在处理数据的时候必须设置该字段，标识数据交付哪个协议处理。例如，字段为 0x0800 时，表示将数据交付给 IP 协议。 |
|      数据      | 也称为效载荷，表示交付给上层的数据。以太网帧数据长度最小为 46 字节，最大为 1500 字节。如果不足 46 字节时，会填充到最小长度。最大值也叫最大传输单元（MTU）。  在 [Linux](http://c.biancheng.net/linux_tutorial/) 中，使用 ifconfig 命令可以查看该值，通常为 1500。 |
| 帧检验序列 FCS | 检测该帧是否出现差错，占 4 个字节（32 比特）。发送方计算帧的**循环冗余码校验**（CRC）值，把这个值写到帧里。接收方计算机重新计算 CRC，与 FCS 字段的值进行比较。如果两个值不相同，则表示传输过程中发生了数据丢失或改变。这时，就需要重新传输这一帧。 |

## 四、网络层

**网络层功能**：IP地址及路由选择

### 网络层基础知识

网络层只**负责在不同网络之间尽力转发数据包，基于数据包的IP地址转发，但不负责重传，不负责按顺序发送。**

实现的设备为 **路由器**

网络层协议：   

- **ARP地址解析协议**
- **IP协议**
- **ICMP 网络控制报文协议**
- **IGMP 网络组管理协议**

###   ARP协议

> ARP协议，中文名字为地址解析协议，**使用ARP协议可以实现将 IP地址 通过广播方式 获得对应主机的物理地址（MAC地址）**。既然是广播方式只能**解析同一网段**的，路由器之外的不能访问到。

 ARP通过广播形式获取目标IP地址的主机MAC地址，并暂时缓存到本地

**ARP常用命令**

> 查看计算机所有绑定的目标主机的MAC地址：`arp -a`。
>
> 将计算机绑定目标主机的MAC地址(静态绑定)，再次通信时，将不再使用ARP协议：`arp  -s  ip地址 MAC地址`

### IP协议

IP协议是TCP/IP协议簇中的核心协议，也是**TCP/IP的载体**。**所有的TCP，UDP，ICMP及IGMP数据都以IP数据报格式传输。**

**特点**：IP协议提供的是**不可靠**的，**无连接**的数据传送服务。

> **不可靠**：指的是不能保证数据报能成功地到达目的地
>
> **无连接**：IP不维护关于后续数据报的状态信息，IP数据可以不按顺序发送和接收。

IP数据包由首部和数据两部分组成

- **首部的前一部分是固定长度，共20字节**，**是所有的IP数据报必须拥有的**
- 在首部的固定部分的后面是一些可选字段，其长度是可变的。

![](https://img-blog.csdn.net/20131220194104812?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2UxMjNfemhvdXdlaQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

> **版本**： 占4位,指IP协议的版本.通信双方使用的IP协议版本必须一致.日前广泛使用的 IP协议版本号为 4 (即 IPv4).IPv6 目前还处于起步阶段.
>
> **首部长度**
>
> **服务类型**
>
> **总长度**：总长度指**首部及数据之和的长度**，单位为字节，因为总长度字段为16位，所以数据报的最大长度为2^16-1=65535字节，在Ip层下面的每一种数据链路层都有自己的帧格式，其中包括帧格式中的数据字段的最大长度，即最大传送单元MTU。当一个数据报封装成链路层的帧时，此时数据报的总长度（即首部加上数据部分）一定不能超过下面的数据链路层的MTU值（1500字节），否则要**分片**。
>
> **标识**：占16位，IP软件在存储器中维持一个计数器,每产生一个数据报,计数器就加 1,并将此值赋给标识字段.但这个"标识"并不是序号,因为 IP是无连接的服务,数据报不存在按序接收的问题.当数据报由于长度超过网络的 MTU 而必须分片时,这个标识字段的值就被复制到所有的数据报的标识字段中.**相同的标识字段的值使分片后的各数据报片最后能正确地重装成为原来的数据报.**
>
> **标志 (Flag):**占3 位,但目前只有2位有意义. 标志字段中的最低位记为 MF(More Fragment).**MF=1即表示后面"还有分片"的数据报.MF=0表示这已是若干数据报片中的最后一个**.**标志字段中间的一位记为DF(Don't Fragment),意思是"不能分片",只有当 DF=0时才允许分片.** 
>
> **片偏移:**占 13位.较长的分组在分片后,某片在原分组中的相对位置.也就是说,相对用户数据字段的起点,该片从何处开始.片偏移以 8个字节为偏移单位,这就是说,每个分片的长度一定是 8字节(64位)的整数倍。
>
> **生存时间:**占 8位,生存时间字段常用的英文缩写是TTL(Time To Live),其表明数据报在网络中的寿命.由发出数据报的源点设置这个字段.其目的是防止无法交付的数据报无限制地在因特网中兜圈子,因而白白消耗网络资源.最初的设计是以秒作为 TTL的单位.每经过一个路由器时,就把TTL减去数据报在路由器消耗掉的一段时间.若数据报在路由器消耗的时间小于 1 秒,就把TTL值减 1.当 **TTL值为 0**时,就丢弃这个数据报。
>
> **协议:**占 8 位.协议字段指出此数据报携带的数据是使用何种协议,以便使目的主机的IP层知道应将数据部分上交给哪个处理过程.详细资料请看文章最后的注释.
>
> ​      协议号：ICMP协议号 ->   1
>
> ​                      IGMP协议号 ->  2  
>
> ​                      TCP           ->      6
>
> ​                      UDP          ->     17
>
> ​                      IPv6          ->     41
>
> ​                      OSPF         ->     89
>
> **首部检验和:**占 16位.这个字段只检验数据报的首部,但不包括数据部分.这是因为数据报每经过一个路由器,都要重新计算一下首都检验和 (一些字段,如生存时间,标志,片偏移等都可能发生变化),不检验数据部分可减少计算的工作量.
> **源地址:**占32位.
> **目的地址:**占 32位.

**静态路由**

由网络管理员手动配置的路由信息。当网络的拓扑结构或链路的状态发生变化时，网络管理员需要手动去修改路由表中相关信息的静态路由信息。静态路由信息在缺省情况下是私有的，不会传递给其他的路由器。  

**动态路由**

由路由器能够自动地建立自己的路由表，并且能够根据实际情况的变化适时的进行调整。动态路由机制的运作依赖路由器的两个基本功能：对路由表的维护；路由器之间适时的路由信息交换。

### ICMP协议

主要常用命令 `ping` 命令，**用于测试网络连接**

ICMP协议的功能主要有：
1. **确认IP包是否成功到达目标地址**
2. **通知在发送过程中IP包被丢弃的原因**

注意：

> **ICMP是基于IP协议工作的，但是它并不是传输层的功能，因此仍然把它归结为网络层协议**；
>
> ICMP只能搭配IPv4，如果是IPv6的情况下，需要使用ICMPv6。

粗略判断目标地址的操作系统：

> ping目标地址，查看延迟：
>
> ​    Linux            64
>
> ​    Windows     128
>
> ​    Unix              255

除了ping命令 还有 `pathping` 命令能够统计到目标地址转发详细记录。**跟踪数据包路径， 计算丢包情况。**

### IGMP协议

IGMP：用来在接收者与其直接相邻的组播路由器之间建立、维护组播成员关系
主要运行在主机与组播路由器之间，

就是一组数据可以同时
作用：

> 主机侧：向路由器通告组成员关系
> 路由器侧：维护组成员关系

### IP子网划分

#### 什么是IP地址

> IP地址在网络中用于标识一个节点（或网络设备的接口）

#### IP地址的类别

> IP地址由两部分组成，即[网络地址](http://baike.baidu.com/view/547479.htm)和[主机地址](http://baike.baidu.com/view/547482.htm)。网络地址表示其属于互联网的哪一个网络，主机地址表示其属于该网络中的哪一台主机。二者是主从关系
>
> ![](https://images2018.cnblogs.com/blog/1440532/201809/1440532-20180912093201807-306001370.png)
>
> IP地址根据网络号和主机号来分，分为A、B、C三类及特殊地址D、E。

A类：(1.0.0.0-126.0.0.0)（默认子网掩码：255.0.0.0或 0xFF000000）第一个字节为网络号，后三个字节为主机号。该类IP地址的最前面为“0”，所以地址的网络号取值于1~126之间。一般用于大型网络。

B类：(128.0.0.0-191.255.0.0)（默认子网掩码：255.255.0.0或0xFFFF0000）前两个字节为网络号，后两个字节为主机号。该类IP地址的最前面为“10”，所以地址的网络号取值于128~191之间。一般用于中等规模网络。

C类：(192.0.0.0-223.255.255.0)（子网掩码：255.255.255.0或 0xFFFFFF00）前三个字节为网络号，最后一个字节为主机号。该类IP地址的最前面为“110”，所以地址的网络号取值于192~223之间。一般用于小型网络。

D类：是多播地址。该类IP地址的最前面为“1110”，所以地址的网络号取值于224~239之间。一般用于多路广播用户[1]  。

E类：是保留地址。该类IP地址的最前面为“1111”，所以地址的网络号取值于240~255之间。

#### IP子网划分

为了解决IPv4的不足，提高网络划分的灵活性，VLSM（可变长子网掩码）用于IPv4子网的划分，也就是把一个大的网络划分成多个小的子网；

**VLSM子网划分的思想**

>  **就是借用现有网段的主机号的最左边某几位作为子网位，划分出多个子网。**

**如何进行子网划分**

- 判断IP类别，找掩码
- **变更掩码**，找子网
- 得出子网号
- 得出主机段
- 得出广播号

## 五、传输层

传输层的功能：**端对端的连接**，**传输层提供应用进程之间的逻辑通信**

传输层协议 ： 

- **TCP(Transmission Control Protocol)协议** 

- **UDP(User Data Protocol)协议**

dos命令查看网络连接地址端口等信息，

查看会话使用`netstat -n`；

查看建立会话的进程`netstat -nb`；

测试远程计算机某个端口是否可以打开：`netstat  ip地址 端口号`

### 传输层提供的服务

传输层寻址和端口

传输层主要是提供**不同主机**上的**进程之间**的逻辑通信（端到端的通信），即使在不可靠的网络层（主机间的逻辑通信）传输下，传输层也能提供可靠的传输

**常见的数值端口号**

| 应用进程 | FTP  | TELNET | SMTP |    DNS    | TFTP | HTTP | HTTPS | SNMP |
| :------: | :--: | :----: | :--: | :-------: | :--: | :--: | :---: | ---- |
|  端口号  |  21  |   23   |  25  | （UDP）53 |  69  |  80  |  443  | 161  |

### UDP(用户数据报协议)

UDP(用户数据报协议)是一个简单的面向数据报的运输层协议。UDP**不提供可靠性**，它只是把应用程序传给IP层的数据报发送出去，但是并不能保证它们能到达目的地。由于UDP在传输数据报前不用在客户和服务器之间建立一个连接，且没有超时重发等机制，故而传输**速度很快**。

> - UDP是无连接的，即发送数据之前不需要建立连接。
> - UDP使用最大努力交付，即不保证可靠交付，同时也不能使用拥塞控制。
> - UDP是面向报文的。UDP没有拥塞控制，很适合多媒体通信的要求。
> - UDP支持一对一、一对多、多对一和多对多的交互通信
> - UDP的首部开销小，只有8个字节

UDP数据报

![](https://s1.51cto.com/images/20180821/1534845652351546.jpeg?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_100,g_se,x_10,y_10,shadow_90,type_ZmFuZ3poZW5naGVpdGk=)

**IP数据报和UDP数据报的区别**

> IP数据报在网络层要经过路由的存储转发；
>
> UDP数据报是端到端的逻辑信道中的传输，而封装成IP数据报在网络传输层，UDP数据报对路由是不可见的。

### TCP(传输控制协议)

TCP(传输控制协议)提供的是**面向连接**、**可靠**的字节流服务。当客户端和服务器彼此交换数据前，必须先在双方之间**建立一个TCP连接**，之后才能传输数据。

TCP提供**超时重发**，丢弃重复数据，**检验数据**，**流量控制**等功能，保证数据能从一端传到另一端。

**TCP报文**

![](https://s1.51cto.com/images/20180821/1534845641472393.jpeg?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_100,g_se,x_10,y_10,shadow_90,type_ZmFuZ3poZW5naGVpdGk=)

> - 源端口号/目的端口号: 表示数据从哪个进程来, 到哪个进程去.
>
> - 32位**序号**：表示本报文段所发送数据的第一个字节的编号
>
> - 32位**确认号**：表示接收方期望收到发送方下一个报文段的第一个字节数据的编号
>
> - 6位保留
>
> - 6位**标志位**
>
>   URG: 标识紧急指针是否有效，1表示紧急，优先发送
>   **ACK**: 标识确认序号是否有效，（0无效，1有效）
>   PSH: 用来提示接收端应用程序立刻将数据从tcp缓冲区读走
>   RST: 要求重新建立连接. 我们把含有RST标识的报文称为复位报文段
>   **SYN**: 请求建立连接. 我们把含有SYN标识的报文称为同步报文段
>   **FIN**: 通知对端, 本端即将关闭. 我们把含有FIN标识的报文称为结束报文段
>
> - 16位窗口大小：表示现在充许对方发送的数据量，也就是告诉对方，从本报文段的确认号开始允许对方发送的数据量
>
> - 16位检验和: 由发送端填充, 检验形式有CRC校验等. 如果接收端校验不通过, 则认为数据有问题. 此处的校验和不光包含TCP首部, 也包含TCP数据部分.
>
> - 6位紧急指针: 用来标识哪部分数据是紧急数据.

#### TCP如何实现可靠性传输

**TCP通过检验和、序列号、确认应答、重发控制、连接管理以及窗口控制等机制实现可靠性传输**

- **通过序列号与确认应答提高可靠性**

> 当发送端将数据发出后会等待对端的确认应答。如果有确认应答，说明数据已经成功到达对端。反之，则数据丢失的可能性很大。没有收到确认应答并不意味着数据一定丢失。也又可能是对方已经收到了数据，只是返回的确认应答在途中丢失。这种情况也会导致发送端没有收到确认应答而认为数据没有到达目的地，最终重发数据。

- 重发超时的确定

> 重发超时是指在重发数据之前，等待确认应答到来的那个特定时间。如果超过了这个时间仍未收到确认应答，发送端将进行数据重发。

- ## 连接管理(三次握手四次挥手)

- ## 利用窗口控制提高速度

> 确认应答不再是以每个分段，而是以更大的单位进行确认时，转发时间将被大幅度缩短。也就是说，发送端主机在发送了一个段以后不必一直等待确认应答，而是继续发送。
>
> **窗口大小**就是指无需等待确认应答而可以继续发送数据的最大值。

#### TCP如何实现流量控制

> 1.通信双方主机上都分别有一个“发送窗口”和一个“接受窗口”
> 2.TCP连接阶段，双方协商窗口尺寸
> 3.发送方根据协商的结果，发送符合窗口尺寸的数据字节流，并等待对方的确认，等待确认机制
> 4.发送方根据确认信息，改变窗口的尺寸

#### TCP如何实现拥塞控制

> 网络拥塞现象是指到达通信子网中某一部分的分组数量过多,使得该部分网络来不及处理,以致引起这部分乃至整个网络性能下降的现象,严重时甚至会导致网络通信业务陷入停顿,即出现死锁现象。拥塞控制是处理网络拥塞现象的一种机制。
> 1.TCP发送方首先发送一个数据报，然后等待对方的回应
> 2.得到回应后就把这个窗口的大小加倍，然后连续发送两个数据报
> 3.直到出现超时错误，这样，发送端就了解到了通信双方的线路承载能力，也就确定了拥塞窗口的大小

### TCP三次握手和四次挥手全过程

TCP报文格式中还有：Sequence number(序号)、Acknowledge number(确认序号)、标志位

其中标志位，有六种：SYN(建立联机)、ACK(确认)、PSH(传送)、FIN(结束)、PST(重置)、URG(紧急)

**三次握手**

![](https://img-blog.csdn.net/20180717202520531?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4OTUwMzE2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

> - 第一次握手：客户端发送一个请求报文发送给服务器，报文首部中的同步标志位SYN=1,ACK=0, 同时选择一个初始序列号 seq = x，此时客户端进入SYN_SEND状态，等待服务器确认；
> - 第二次握手：服务器收请求报文后，如果同意连接，则发出确认报文，确认报文中的ACK=1，SYN=1，确认序号为x+1，同时也要为自己初始化一个序列号seq = y，发送给客户端，此时服务器进入SYN_RECV状态；
> - 第三次握手：客户端收到服务器发送的数据包，还要想服务器发出确认，发送确认报文，确认报文的ACK=1，确认序号为 y+1，自己的序列号为 x+1，此时包发送完毕，客户端和服务器进入ESTABLISHED状态，完成三次握手。

握手过程中传送的包中不包含数据，三次握手完毕后，客户端与服务器才正式开始传送数据。理想状态下，TCP连接一旦确立，在通信双方中的任何一方主动关闭连接之前，TCP连接都将被一直保持下去。

**四次挥手**

![](https://img-blog.csdn.net/20180717204202563?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4OTUwMzE2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

> - 第一次挥手：主动关闭方，发送一个FIN = 1,seq = u（结束标志），用来关闭主动方到被动关闭方的数据传送，也就是主动关闭方告诉被动关闭方：我已经不会再给你发送数据了，但是，**此时主动关闭方还可以接受数据**。
> - 第二次挥手：**被动关闭方接收到FIN包后，其实不会直接发送FIN标志断开通信的请求，而是先发送一个带有ACK标志的应答信息，使主动关闭方明白还有数据要进行发送**。发送一个ACK = 1,seq = v给对方，确认序号ack 为u + 1，（与syn相同，一个FIN占用一个序号）
> - 第三次挥手：被动关闭方发送一个FIN  = 1（结束标志）,ACK = 1,seq = w,确认序号ack=u+1数据包，告诉主动关闭方，我的数据也发送完了，不会再给你发数据了,通知对方断开连接。
> - 第四次挥手：主动关闭方收到数据包后，担心网络上某些不可控制的因素导致服务器不知道它要断开连接，会发送一个ACK=1给被动关闭方，序号为u+1，确认序号为w+1，同时把自己设置成TIME_WAIT状态并启动定时器，在TCP的定时器到达客户端并没有接收到请求，会重新发送；当对方收到请求后就断开连接，完成四次握手。

补充：**套接字**（socket）。

我们知道在网络中通过Ip来唯一标识一个主机。而通过端口号来标识一台主机中的不同应用进程。所以在网络连接中就出现了Socket套接字来标识一个主机上的某进程。其实际是一个通信端点。

**套接字（Socket） = (Host IP , port)**

## 六、应用层

**应用层特点：**

> - 每个应用层协议都是为了解决某一类应用问题，而问题的解决又往往是通过位于不同主机中的多个应用进程之间的通信和协同工作来完成的。应用层的具体内容就是规定应用进程在通信时所遵循的协议。
> - 应用层的许多协议都是基于客户服务器方式。客户 (client) 和服务器 (server) 都是指通信中所涉及的两个应用进程。客户服务器方式所描述的是进程之间服务和被服务的关系。客户是服务请求方，服务器是服务提供方。

### DNS域名解析协议

功能：**负责解析域名，将域名解析成IP地址**

**什么是域名**

> - 根级域名                 用 **.** 表示，常忽略不写
> - 顶级(一级)域名       com  edu    net   cn   org    gov
> - 二级域名                 baidu    taobao

### DHCP动态主机配置

静态IP地址

动态IP地址

### SMTP电子邮件传输协议

SMTP是建立在FTP文件传输服务上的一种邮件服务

### FTP文件传输协议

FTP 使用 2 个端口，一个数据端口和一个命令端口（也叫做控制端口）。这两个端口一般是21 （命令端口）和 20 （数据端口）。控制 Socket 用来传送命令，数据 Socket 是用于传送数据。每一个 FTP 命令发送之后，FTP 服务器都会返回一个字符串，其中包括一个响应代码和一些说明信息。其中的返回码主要是用于判断命令是否被成功执行了。

主动模式：

> FTP客户端告诉FTP服务器使用什么端口监听
>
> FTP服务器和FTP客户端的这个端口建立连接，源端口20

被动模式：

> FTP服务器端，如果有防火墙，需要在防火墙开放21和20端口，使用主动模式进行数据连接

### TELNET远程终端协议

默认TCP端口23

### RDP远程桌面协议

（Remote Desktop Protocol）

### HTTP超文本传输协议

http协议是一个客户端和服务端请求和应答的标准（TCP）。尽管TCP/IP协议是互联网上最流行的应用，HTTP并没有规定必须使用。但通常，由http客户端发起一个请求，建立一个到服务器指定端口（默认是80端口）的TCP连接。

通过HTTP或者HTTPS协议请求的资源由**统一资源标示符**（URI）来标识。

**HTTP协议的组成**

> HTTP协议由**HTTP请求**和**HTTP响应**组成
>
> HTTP请求包括：请求行、请求头、请求体
>
> HTTP响应包括：响应行、响应头、响应体

**HTTP特点**：

> - **基于请求/响应模式的协议**。请求和响应必须成对，先有请求后有响应。
>
> - http协议默认端口为80
>
> - 简单快速：客户想服务器请求服务时，只需传送请求方法和路径，请求的方法通常有GET、PUT、POST等，每种方法规定了客户与服务器联系的类型不同。
> - **灵活**：http**允许传输任意类型的数据对象**。正在传输的类型由**Content-Type**加以标记
> - **无连接**：无连接的含义是**限制每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接。采用这种方式可以节省传输时间**。
> - **无状态**：HTTP协议是无状态协议。**无状态是指协议对于事务处理没有记忆能力**。这种方式的一个坏处就是，如果后续的处理需要用到之前的信息，则必须要重传，这样就导致了每次连接传输的数据量增大，好处就是，如果后续的连接不需要之前提供的信息，响应就会比较快，而为了解决HTTP的无状态特性，出现了Cookie和Session技术。

**TCP/IP协议**

![](https://img-blog.csdnimg.cn/20190611144820612.png?)

### RPC远程服务调用协议

**HTTP响应状态码**

![](https://img-blog.csdnimg.cn/20190612155737768.jpg?)

